---
title: "Group-by"
author: "ZJ"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Group-by}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

### Group by
Starting from {disk.frame} v0.2.2, there is for support `group_by` for a limited set of functions. For example:

```r
result_from_disk.frame = iris %>% 
  as.disk.frame %>% 
  group_by(Species) %>% 
  summarize(
    mean(Petal.Length), 
    sumx = sum(Petal.Length/Sepal.Width), 
    sd(Sepal.Width/ Petal.Length), 
    var(Sepal.Width/ Sepal.Width), 
    l = length(Sepal.Width/ Sepal.Width + 2),
    max(Sepal.Width), 
    min(Sepal.Width), 
    median(Sepal.Width)
    ) %>% 
  collect
```

The results should be exactly the same as if applying the same group-by operations on a data.frame. If not then please [report a bug](https://github.com/xiaodaigh/disk.frame/issues).

#### List of supported group-by functions

If a function you like is missing, please make a feature request [here](https://github.com/xiaodaigh/disk.frame/issues). It is a limitation that function that depend on the order a column can only obtained using estimated methods.

| Function | Exact/Estimate | Notes |
| -- | -- | -- |
| `min` | Exact |  |
| `max` | Exact |  |
| `mean` | Exact |  |
| `sum` | Exact |  |
| `length` | Exact |  |
| `n` | Exact |  |
| `n_distinct` | Exact |  |
| `sd` | Exact |  |
| `var` | Exact | `var(x)` only `cor, cov` support *planned*  |
| `any` | Exact |  |
| `all` | Exact |  |
| `median` | Estimate |  |
| `quantile` | Estimate | One quantile only |
| `IQR` | Estimate |  |

### Two-Stage Group by
Given the list of group-by functions is limited, so {disk.frame} supports a two-stage style grouping, enable maximum flexibility. The key is understand that `chunk_group_by` performs `group-by` within each chunk.

```{r flights_df, dependson='setup', cache=TRUE}
flights.df = as.disk.frame(nycflights13::flights)

flights.df %>%
  srckeep(c("year","distance")) %>%  # keep only carrier and distance columns
  chunk_group_by(year) %>% 
  chunk_summarise(sum_dist = sum(distance)) %>% # this does a count per chunk
  collect
```

This is two-stage group-by in action
```{r, dependson='flights_df'}
# need a 2nd stage to finalise summing
flights.df %>%
  srckeep(c("year","distance")) %>%  # keep only carrier and distance columns
  chunk_group_by(year) %>% 
  chunk_summarise(sum_dist = sum(distance)) %>% # this does a count per chunk
  collect %>% 
  group_by(year) %>% 
  summarise(sum_dist = sum(sum_dist))
```

You can mix group-by with other dplyr verbs as below, here is an example of using `filter`. 

```{r, dependson='flights_df'}
# filter
pt = proc.time()
df_filtered <-
  flights.df %>% 
  filter(month == 1)
cat("filtering a < 0.1 took: ", data.table::timetaken(pt), "\n")
nrow(df_filtered)
```

### Hard group by
Another way to perform a one-stage `group_by` is to perform a `hard_group_by` on a `disk.frame. This will rechunk the `disk.frame` by the by columns. This is **not** recommended for performance reasons, as it can quite slow to rechunk the chunks on disk.
```{r}
pt = proc.time()
res1 <- flights.df %>% 
  srckeep(c("month", "dep_delay")) %>% 
  filter(month <= 6) %>% 
  mutate(qtr = ifelse(month <= 3, "Q1", "Q2")) %>% 
  hard_group_by(qtr) %>% # hard group_by is MUCH SLOWER but avoid a 2nd stage aggregation
  chunk_summarise(avg_delay = mean(dep_delay, na.rm = TRUE)) %>% 
  collect
cat("group by took: ", data.table::timetaken(pt), "\n")

collect(res1)
```

## Advertisements

### Interested in learning {disk.frame} in a structured course?

Please register your interest at:

https://leanpub.com/c/taminglarger-than-ramwithdiskframe

### Open Collective 

If you like disk.frame and want to speed up its development or perhaps you have a feature request? Please consider sponsoring {disk.frame} on Open Collective. Your logo will show up here with a link to your website.

#### Backers

Thank you to all our backers! üôè [[Become a backer](https://opencollective.com/diskframe#backer)]

<a href="https://opencollective.com/diskframe#backers" target="_blank"><img src="https://opencollective.com/diskframe/backers.svg?width=890"></a>

[![Backers on Open Collective](https://opencollective.com/diskframe/backers/badge.svg)](#backers)

#### Sponsors

 [[Become a sponsor](https://opencollective.com/diskframe#sponsor)]

 [![Sponsors on Open Collective](https://opencollective.com/diskframe/sponsors/badge.svg)](#sponsors) 

### Contact me for consulting

**Do you need help with machine learning and data science in R, Python, or Julia?**
I am available for Machine Learning/Data Science/R/Python/Julia consulting! [Email me](mailto:dzj@analytixware.com)
